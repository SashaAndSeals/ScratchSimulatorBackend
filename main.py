import scratchattach as scratch3
from PIL import Image
from io import BytesIO
import urllib.request
def get_image(ID,im_type,size):
    if im_type == "user":
        url = "https://cdn2.scratch.mit.edu/get_image/user/"+str(ID)+"_32x32.png?v="                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    elif im_type == "project":
        url = "https://cdn2.scratch.mit.edu/get_image/project/"+str(ID)+"_100x80.png?v="
    response = urllib.request.urlopen(url)
    img = Image.open(BytesIO(response.read()))
    img = img.convert('HSV')
    img_pixels=[]
    img=img.resize(size)
    for x in range(size[0]):
        for y in range(size[1]):
            h,s,v=img.getpixel((x,y))
            h=int(round(h*(99/255)))
            s=int(round(s*(99/255)))
            v=int(round(v*(99/255)))
            img_pixels.append(str(h)+","+str(s)+","+str(v))
    return img_pixels
session = scratch3.Session(input("Session ID:"), username=input("Username:")) 
conn = session.connect_cloud(input("Project ID:")) 
client = scratch3.CloudRequests(conn)

@client.request
def get_user(argument1): 
    user = scratch3.get_user(argument1)
    data = [user.country,user.join_date.split("T")[0].replace("-"," "),user.about_me,user.wiwo]
    feat_project = user.featured_data()
    try:
        data.extend([feat_project["label"],feat_project["project"]["title"]])
        feat_project_img = get_image(feat_project["project"]["id"],"project",(20,16))
    except: 
        data.extend(["Featured Project","Doesn't exits for this user."])
        feat_project_img=[]
    user_img = get_image(user.id,"user",(16,16))
    data.extend(user_img)
    data.extend(feat_project_img)
    return data

@client.request
def get_project(argument1):
    project = scratch3.get_project(int(argument1))
    data = [project.title,project.author,project.instructions,project.notes,project.loves,project.favorites,project.views,project.remix_count]
    img = get_image(project.id,"project",(33,26))
    data.extend(img)
    return data

@client.request
def search(argument1):
    arg1=argument1.split("§")
    search = scratch3.search_projects(query=arg1[0],mode="popular",language="en",limit=20)
    project = search[int(arg1[1])]
    data = [project.title,project.author,project.instructions,project.notes,project.loves,project.favorites,project.views,project.remix_count]
    img = get_image(project.id,"project",(33,26))
    data.extend(img)
    return data

@client.event
def on_ready():
    print("Request handler is running!")
client.run()

#☁︎ makes encoding
